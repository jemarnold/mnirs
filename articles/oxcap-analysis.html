<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Analysing muscle oxidative capacity with {mnirs} • mnirs</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="oxcap-analysis_files/libs/quarto-html/popper.min.js"></script><script src="oxcap-analysis_files/libs/quarto-html/tippy.umd.min.js"></script><link href="oxcap-analysis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="oxcap-analysis_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Analysing muscle oxidative capacity with {mnirs}">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@jem_arnold">
<meta name="twitter:site" content="@jem_arnold">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mnirs</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/oxcap-analysis.html">Analysing muscle oxidative capacity with {mnirs}</a></li>
    <li><a class="dropdown-item" href="../articles/reading-mnirs-data.html">Reading and Cleaning Data with {mnirs}</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://bsky.app/profile/jemarnold.bsky.social" aria-label="Bluesky"><span class="fa fa-brands fa-bluesky"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/jem_arnold" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jemarnold/mnirs" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Analysing muscle oxidative capacity with {mnirs}</h1>

      <p class="author">Jem Arnold</p>
      <p class="date">2026-02-08</p>

      <small class="dont-index">Source: <a href="https://github.com/jemarnold/mnirs/blob/main/vignettes/articles/oxcap-analysis.qmd" class="external-link"><code>vignettes/articles/oxcap-analysis.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <section class="section level2"><h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>I am continuing to develop the <a href="https://github.com/jemarnold/mnirs" class="external-link"><em><code>{mnirs}</code></em></a> package for processing and analysing muscle near-infrared spectroscopy in R.</p>
<p>In this article, I will demonstrate how the recently added functionality can be combined to perform muscle oxidative capacity (OxCap) analysis from a repeated ischaemic occlusion protocol, while ensuring reproducibility and adhering to current gold-standard processing methods.</p>
<div>
<blockquote>
<p><strong>Tip</strong></p>
<p>This article assumes basic familiarity with the <em>{mnirs}</em> package. For an overview and demonstration of data processing with <em>{mnirs}</em>, please see the package vignette <a href="https://jemarnold.github.io/mnirs/articles/reading-mnirs-data.html"><em>Reading and Cleaning Data with {mnirs}</em></a>.</p>
</blockquote>
</div>
<section class="level3"><h4 id="muscle-oxidative-capacity-testing">Muscle oxidative capacity testing<a class="anchor" aria-label="anchor" href="#muscle-oxidative-capacity-testing"></a>
</h4>
<p>One of the most compelling applications emerging in mNIRS research is the ability to non-invasively evaluate <strong>muscle oxidative capacity</strong> after a dynamic exercise task.</p>
<p>Oxidative capacity is the maximal rate at which a muscle utilises oxygen (O<sub>2</sub>) to meet the energetic demand of exercise, and is related to mitochondrial respiratory function <span class="citation" data-cites="Beever2020">[<a href="#ref-Beever2020" role="doc-biblioref">1</a>]</span>.</p>
<p>Traditionally, OxCap assessment requires highly complex and invasive in-vitro methods such as high-resolution respirometry of biopsy tissue samples, or expensive in-vivo <sup>31</sup>P magnetic resonance spectroscopy.</p>
<p>With mNIRS, muscle OxCap can be assessed non-invasively during more dynamic exercise tasks, and with lower cost and burden than traditional methods previously available.</p>
</section><section class="level3"><h4 id="protocol-overview">Protocol overview<a class="anchor" aria-label="anchor" href="#protocol-overview"></a>
</h4>
<p>The participant is asked to perform a brief exercise task or muscle contraction stimulus to elevate the O<sub>2</sub> demand in the target tissue, with mNIRS sensors over the peripheral muscle of interest and an occlusion cuff ready (deflated) around the proximal limb.</p>
<p>Immediately after the stimulus, the occlusion cuff is rapidly inflated to a supra-systolic blood pressure (e.g., 300 mmHg) to transiently stop blood flow into the distal target muscle site.</p>
<p>The occlusion is held for a brief period such as 5-seconds, then deflated to allow recovery to proceed. A sequence of these brief, repeated occlusions are performed at a pre-specified tempo (e.g. 5-sec occlusion, 10-sec recovery) for up to twenty repetitions (~5-minutes) until the muscle has recovered back to baseline.</p>
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="figures/McCully-2024.jpg"></p>
<figcaption>Figure 2 from McCully et al, 2024 <span class="citation" data-cites="McCully2024">[<a href="#ref-McCully2024" role="doc-biblioref">2</a>]</span>. (A) The experimental setup for the progressive exercise test. The NIRS device was placed on the vastus lateralis using straps. The blood pressure cuff was placed proximally to the NIRS device. The leg is shown lifting the weight. For NIRS measurements, the leg was placed on top of the padding in the horizontal position to allow the muscle to relax during the measurements.</figcaption></figure>
</div>
<p>During each occlusion where oxygen delivery is constrained and assumed to be zero, the rate of deoxygenation — the slope of the rise in deoxyhaeme (HHb/time; μM/sec), or decline in oxygen saturation or oxyhaeme — is interpreted to represent the rate of local muscle oxygen uptake (mV̇O<sub>2</sub>).</p>
<p>Immediately after the exercise task when metabolic demand is high, mV̇O<sub>2</sub> will be elevated. It will decline at an exponential rate as recovery proceeds back to baseline. The rate constant (<em>k</em>, min<sup>-1</sup>) of this monoexponential curve quantifies the muscle OxCap value <span class="citation" data-cites="Adami2018">[<a href="#ref-Adami2018" role="doc-biblioref">3</a>]</span>.</p>
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="figures/Adami-2018.jpg"></p>
<figcaption>Figure 1 from Adami et al, 2018 <span class="citation" data-cites="Adami2018">[<a href="#ref-Adami2018" role="doc-biblioref">3</a>]</span>. Muscle oxygen consumption (mVO2) recovery rate constant (k) by near-infrared spectroscopy. A and B: example of the oxidative capacity test by NIRS. A: changes in the tissue saturation index (TSI) during dynamic exercise (EX, gray area) and subsequent intermittent arterial occlusions at rest. B: mVO2 recovery kinetics derived from the rate of change of TSI during intermittent arterial occlusions measured from A. mVO2 recovery data are fit to an exponential (dashed line) to estimate the recovery k. C: summaries of current reports of the mVO2 recovery rate constant (k), which is proportional to oxidative capacity, in upper and lower limbs of adults in health and disease. A and B: redrawn with permission from Elsevier (1).</figcaption></figure>
</div>
<p>This technique has been well studied in recent years, validated against <sup>31</sup>P-MRS <span class="citation" data-cites="Ryan2013">[<a href="#ref-Ryan2013" role="doc-biblioref">4</a>]</span> and mitochondrial content protein markers <span class="citation" data-cites="Tripp2023">[<a href="#ref-Tripp2023" role="doc-biblioref">5</a>]</span>. The rate constant <em>k</em> has been shown to be proportionally higher (faster recovery) in endurance-trained muscle, and lower (slower) in pathalogical and diseased muscle <span class="citation" data-cites="Adami2018">[<a href="#ref-Adami2018" role="doc-biblioref">3</a>]</span>.</p>
</section><section class="level3"><h4 id="a-call-for-standardised-processing-methods">A call for standardised processing methods<a class="anchor" aria-label="anchor" href="#a-call-for-standardised-processing-methods"></a>
</h4>
<p>Technical procedures and analysis methods for OxCap assessment have converged toward standardisation in recent years, with methods showing good reliability and reproducibility.</p>
<p>Recently there has been a call to implement standard analysis scripts with robust slope detection and non-linear modelling, to minimise operator-related variability between research centres, and thereby improving interpretation of outcomes across populations and interventions <span class="citation" data-cites="Costalat2025 Rasica2024">[<a href="#ref-Costalat2025" role="doc-biblioref">6</a>,<a href="#ref-Rasica2024" role="doc-biblioref">7</a>]</span>.</p>
<p>I wanted to see how well (or poorly) my current <em>{mnirs}</em> functionality could process and analyse repeated occlusion muscle OxCap data.</p>
<p>In the future, this process will be wrapped into convenience functions to make the process easier for the end user. But I believe this process is already considerably simpler and more robust than non-reproducible methods relying on manual data cleaning, occlusion interval selection, and curve fitting.</p>
</section></section><section class="section level2"><h2 id="oxidative-capacity-analysis-in-mnirs">Oxidative capacity analysis in <em>{mnirs}</em>
<a class="anchor" aria-label="anchor" href="#oxidative-capacity-analysis-in-mnirs"></a>
</h2>
<p>This article serves as a vignette for three analysis functions recently added to the <em>{mnirs}</em> package, and how they can be used together to perform robust OxCap analysis.</p>
<ul>
<li><p><code><a href="../reference/extract_intervals.html">extract_intervals()</a></code>: is used to detect specific events or times in an <em><code>mnirs</code></em> data frame, and extract an interval around each one, returning a list of data frames.<br><br>
This is useful when a certain event is labelled in <code>event_channel</code>, or a list of time values is provided manually for when events occur, such as the start of an exercise interval or occlusion. The returned list of data frames is ready for further analysis. See <code><a href="../reference/extract_intervals.html">?extract_intervals</a></code> for more details.</p></li>
<li><p><code><a href="../reference/peak_slope.html">peak_slope()</a></code>: is used to find the peak positive or negative linear regression slope from a numeric vector and return the slope value, intercept, and associated parameters.<br><br>
The segment of an mNIRS signal with the steepest slope is often interpreted to represent the point of greatest mismatch between O<sub>2</sub> supply and O<sub>2</sub> demand, such as for muscle OxCap testing. See <code><a href="../reference/peak_slope.html">?peak_slope</a></code> for more details.</p></li>
<li><p><code><a href="../reference/monoexponential.html">monoexponential()</a></code>: specifies the equation for an exponential function. Two self-starting functions are available for non-linear curve fitting; <code><a href="../reference/SS_monoexp.html">SS_monoexp4()</a></code> fits a 4-parameter monoexponential model, while <code><a href="../reference/SS_monoexp.html">SS_monoexp3()</a></code> fits a reduced 3-parameter model without a time delay parameter, where monoexponential response is expected to be instantaneous.<br><br>
Calling these functions in non-linear curve fitting functions (e.g. <code><a href="https://rdrr.io/r/stats/nls.html" class="external-link">nls()</a></code>) will return model coefficients for the three or four parameters. See <code><a href="../reference/monoexponential.html">?monoexponential</a></code> and <code><a href="../reference/SS_monoexp.html">?SS_monoexp</a></code> for more details.</p></li>
</ul>
<section class="level3"><h4 id="analysis-plan">Analysis plan<a class="anchor" aria-label="anchor" href="#analysis-plan"></a>
</h4>
<p>For OxCap analysis, we will perform roughly 8 steps:</p>
<ol type="1">
<li>Import an example NIRS file with the repeated occlusions procedure.</li>
<li>Pre-process/clean data, as needed (minimal in this example).</li>
<li>Iteratively correct NIRS values for changes in blood volume, a required step to ensure valid analysis.</li>
<li>Specify occlusion events in the data and extract a 5-sec intervals for all occlusions.</li>
<li>Find the peak 3-sec linear regression NIRS slope within each occlusion event.</li>
<li>Model a monoexponential curve fit across NIRS slope observations within both repeated occlusion trials.</li>
<li>Extract the rate constant (<em>k</em>) for each trial exponential curve.</li>
<li>Plot the modelled data.</li>
</ol>
<p>My aim is to perform this analysis using only the <em>{mnirs}</em> package and <em>{tidyverse}</em> functions, keeping the script as clean as possible, with as few janky manual adjustments as necessary.</p>
</section><section class="level3"><h4 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h4>
<p>First, load our packages and initial setup options. We will silence <em>{mnirs}</em> info messages and set our ggplot2 theme.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span> <span class="co">## tidyverse packages for convenient data wrangling</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jemarnold.github.io/mnirs/">mnirs</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mnirs.verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co">## globally silence info/warning messages</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/get_theme.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="../reference/theme_mnirs.html">theme_mnirs</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span><span class="op">)</span> <span class="co">## set ggplot2 theme for plotting</span></span></code></pre></div>
</div>
<div>
<blockquote>
<p><strong>Note</strong></p>
<p>I received this example file from <a href="https://scholar.google.com/citations?user=A9JwQbYAAAAJ&amp;hl=en" class="external-link">Dr. Thomas Tripp</a>, Postdoctoral fellow in Dr. <a href="https://scholar.google.com/citations?hl=en&amp;user=tJepNIQAAAAJ" class="external-link">Martin MacInnis</a>’ lab at the University of Calgary. They have kindly allowed me to include this file with the <em>{mnirs}</em> package for users to examine themselves.</p>
<p>It can be accessed by calling <code>example_mnirs("portamon-oxcap")</code>.</p>
</blockquote>
</div>
<p>This article will assume basic familiarity with the <em>{mnirs}</em> package. For further details and demonstration of data processing, please see the package vignette <a href="https://jemarnold.github.io/mnirs/articles/reading-mnirs-data.html"><em>Reading and Cleaning Data with {mnirs}</em></a>.</p>
</section></section><section class="section level2"><h2 id="read-mnirs-data-file">Read <em>{mnirs}</em> data file<a class="anchor" aria-label="anchor" href="#read-mnirs-data-file"></a>
</h2>
<p>The included example file has three NIRS channels and a column with sample number, which will automatically be converted to a time value when the <code><a href="../reference/read_mnirs.html">read_mnirs()</a></code> function recognises the <em>Artinis Oxysoft</em> export format and sample rate (10 Hz). The file does not need to be cleaned for outliers or digitally filtered, so minimal pre-processing is required.</p>
<p>One thing to note: <em>Artinis Oxysoft</em> exports an event label column without a named header by default. This is the column we will use to identify our occlusion events by the label <code>"Occlusion"</code>, so we need to include it. Currently in <em>{mnirs}</em> an unnamed column like this will be named <code>"col_"</code> with a numeric suffix for the column number in the data file. In our example file, this events column will therefore be <code>"col_6"</code>. It’s not the most elegant solution, but it works for now!</p>
<p>We can separate the two trials in the data set by finding the longer gap between consecutive occlusion labels and manually defining intervals before that as trial 1, and after that as trial 2.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_mnirs.html">read_mnirs</a></span><span class="op">(</span></span>
<span>    file_path <span class="op">=</span> <span class="fu"><a href="../reference/example_mnirs.html">example_mnirs</a></span><span class="op">(</span><span class="st">"portamon-oxcap.xlsx"</span><span class="op">)</span>,</span>
<span>    nirs_channels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>thb <span class="op">=</span> <span class="fl">2</span>, hhb <span class="op">=</span> <span class="fl">3</span>, o2hb <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, <span class="co">## identify and rename NIRS channels</span></span>
<span>    time_channel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    event_channel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>event <span class="op">=</span> <span class="st">"col_6"</span><span class="op">)</span> <span class="co">## specify the unnamed events column</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## view the structure of our data frame</span></span>
<span><span class="va">df</span></span>
<span><span class="co">#&gt; # A tibble: 7,944 × 6</span></span>
<span><span class="co">#&gt;    sample  time event   thb   hhb  o2hb</span></span>
<span><span class="co">#&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1      0   0   &lt;NA&gt;   146.  63.0  82.9</span></span>
<span><span class="co">#&gt;  2      1   0.1 &lt;NA&gt;   146.  63.0  82.8</span></span>
<span><span class="co">#&gt;  3      2   0.2 &lt;NA&gt;   146.  63.0  82.8</span></span>
<span><span class="co">#&gt;  4      3   0.3 &lt;NA&gt;   146.  63.0  82.9</span></span>
<span><span class="co">#&gt;  5      4   0.4 &lt;NA&gt;   146.  63.0  82.7</span></span>
<span><span class="co">#&gt;  6      5   0.5 &lt;NA&gt;   146.  62.9  82.6</span></span>
<span><span class="co">#&gt;  7      6   0.6 &lt;NA&gt;   146.  62.9  82.7</span></span>
<span><span class="co">#&gt;  8      7   0.7 &lt;NA&gt;   146.  62.9  82.8</span></span>
<span><span class="co">#&gt;  9      8   0.8 &lt;NA&gt;   146.  62.9  82.7</span></span>
<span><span class="co">#&gt; 10      9   0.9 &lt;NA&gt;   146.  62.9  82.7</span></span>
<span><span class="co">#&gt; # ℹ 7,934 more rows</span></span>
<span></span>
<span><span class="co">## "Occlusion" is our pre-specified event string in our events column</span></span>
<span><span class="co">## find each occlusion event, find where there is a longer gap</span></span>
<span><span class="co">## the number of occlusions before this should be in the first trial</span></span>
<span><span class="va">df_occlusions</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"Occlusion"</span>, <span class="va">df</span><span class="op">$</span><span class="va">event</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">n_occlusions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">df_occlusions</span><span class="op">$</span><span class="va">time</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">60</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="oxcap-analysis_files/figure-html/read%20file%20and%20pre-process-1.png" class="quarto-figure quarto-figure-center" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The two exercise bouts and repeated occlusion trials can clearly be identified from plotting the raw data. A few resting occlusions were also performed at the start of the file, but we will ignore those and just model the two repeated occlusion trials.</p>
</section><section class="section level2"><h2 id="correct-for-blood-volume">Correct for blood volume<a class="anchor" aria-label="anchor" href="#correct-for-blood-volume"></a>
</h2>
<p>A necessary processing step before analysing the OxCap trials is to apply a correction to the NIRS channels for changes in blood volume during the repeated occlusions. This step has been shown to improve validity when taking slopes of the oxy- or deoxyhaeme channels <span class="citation" data-cites="Ryan2012">[<a href="#ref-Ryan2012" role="doc-biblioref">8</a>]</span>.</p>
<p>The preferred method is to iteratively correct for instantaneous changes in oxygenation between samples, according to Beever et al, 2020 <span class="citation" data-cites="Beever2020">[<a href="#ref-Beever2020" role="doc-biblioref">1</a>]</span>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        <span class="co">## blood volume correction factor beta, requires all positive values</span></span>
<span>        beta <span class="op">=</span> <span class="va">o2hb</span> <span class="op">/</span> <span class="op">(</span><span class="va">o2hb</span> <span class="op">+</span> <span class="va">hhb</span><span class="op">)</span>,</span>
<span>        <span class="co">## use {purrr} to iteratively adjust NIRS values from one sample to the next</span></span>
<span>        <span class="co">## corrected for change in blood volume by beta since the previous sample</span></span>
<span>        o2hb <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/accumulate.html" class="external-link">accumulate</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, \<span class="op">(</span><span class="va">prev</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">prev</span> <span class="op">+</span> <span class="op">(</span><span class="va">o2hb</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">o2hb</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="va">thb</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">thb</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>            <span class="op">}</span>, .init <span class="op">=</span> <span class="fl">0</span></span>
<span>        <span class="op">)</span>,</span>
<span>        hhb <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/accumulate.html" class="external-link">accumulate</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, \<span class="op">(</span><span class="va">prev</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="va">prev</span> <span class="op">+</span> <span class="op">(</span><span class="va">hhb</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">hhb</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">thb</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">thb</span><span class="op">[</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>            <span class="op">}</span>, .init <span class="op">=</span> <span class="fl">0</span></span>
<span>        <span class="op">)</span>,</span>
<span>        <span class="co">## thb corrected for changes in blood volume becomes equal to zero</span></span>
<span>        thb <span class="op">=</span> <span class="va">o2hb</span> <span class="op">+</span> <span class="va">hhb</span>,</span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## plot corrected data with occlusion event indicators</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">df_occlusions</span><span class="op">$</span><span class="va">time</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="oxcap-analysis_files/figure-html/blood%20volume%20correction-1.png" class="quarto-figure quarto-figure-center" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>This results in a symmetrical distribution of oxy- and deoxyhaeme, with the sum total (total-haeme; THb) equal to zero at all samples.</p>
<p>We can also plot occlusion event indicators (vertical dotted lines) to confirm timing and detect any missed/extra events.</p>
</section><section class="section level2"><h2 id="extract-occlusion-intervals">Extract occlusion intervals<a class="anchor" aria-label="anchor" href="#extract-occlusion-intervals"></a>
</h2>
<p>The next step is to identify these occlusion events and extract the interval around each, into a list of data frames which we can continue to analyse iteratively.</p>
<section class="level3"><h4 id="extract_intervals">
<code>extract_intervals()</code><a class="anchor" aria-label="anchor" href="#extract_intervals"></a>
</h4>
<ul>
<li>
<p><code>data</code></p>
<p>This function takes in a data frame, applies processing to all channels specified, then returns a list of processed data frames. <em><code>mnirs</code></em> metadata will be passed to and from this function.<br><br>
For this analysis, we will re-join the returned list of data frames into a combined data frame with a grouping variable labelled “interval”.</p>
</li>
<li>
<p><code>nirs_channels</code>, <code>time_channel</code>, <code>event_channel</code>, &amp; <code>sample_rate</code></p>
<p>Specify which column names in <code>data</code> will be processed. <code>nirs_channels</code> are the response variables; <code>time_channel</code> is the time series variable; <code>event_channel</code> specifies where to look for event labels; and <code>sample_rate</code> specifies the recording rate used when ensemble-averaging across intervals with unequal time samples. If any arguments are not specified, they will be retrieved from <em><code>mnirs</code></em> metadata. Channels in the data but not explicitly specified will be passed through unprocessed to the returned data frames.<br><br>
We will analyse OxCap from the deoxyhaeme (HHb) NIRS signal, which is often recommended <span class="citation" data-cites="Costalat2025">[<a href="#ref-Costalat2025" role="doc-biblioref">6</a>]</span>.</p>
</li>
<li>
<p><code>event_times</code>, <code>event_labels</code>, &amp; <code>event_samples</code></p>
<p>Interval events can be specified by any combination of time (values of <code>time_channel</code>), labels (values of <code>event_channel</code>), or sample (row number). Multiple values can be entered as vectors. At least one event must be specified.<br><br>
Once again, in this example data file, the occlusions are all identified by the event label <code>"Occlusion"</code>. This makes it very simple to detect this string in the <code>event</code> column, and extract intervals around them.<br><br>
Detecting intervals by event labels must match a full string <em>exactly</em>. If the event labels are inconsistent, we could specify a regular expression (regex) string such as <code>"(?i)occlusions?"</code> or <code>"start|end"</code>.</p>
</li>
<li>
<p><code>span</code></p>
<p>Where an event is detected, an interval will be extracted with a time span specified as a two-element numeric vector; <code>c(start, end)</code>, in units of the <code>time_channel</code>. Where positive values represent times after the event, and negative values represent times before the event.<br><br>
All occlusion bouts were held for 5-seconds in this protocol. If the occlusion duration changed across the protocol, we might have to specify a list of time spans, rather than a single <code>span</code> as in this case.<br><br>
From visual investigation of the plots, we were able to see that in the first ~0.5 sec after the occlusion label, the deoxyhaeme signal was disrupted by the inflation of the cuff, which might produce invalid slope values. So we will specify a time span of <code>c(1, 5)</code>, i.e. from 1 to 5 seconds after each <code>"Occlusion"</code> event label. If we wanted to include an interval before the event label, we could specify a negative numeric value, e.g. <code>c(-2.5, 2.5)</code> to include a 5-sec span centred on the label itself.</p>
</li>
<li>
<p><code>group_events</code></p>
<p>Multiple events can be extracted for analysis as <code>"distinct"</code> intervals, or <code>"ensemble"</code>-averaged together. Different groupings of intervals can be ensemble-averaged by providing a list of numeric vectors specifying event intervals by number to ensemble-average or return as distinct; e.g. <code>list(c(1, 2), c(3, 4))</code>.<br><br>
The interval numbers need to be known ahead of time and always refer to their order of occurrence in the data frame (i.e., sorted by <code>time_channel</code>). Any event intervals detected but not supplied by number will be included as distinct data frames.</p>
</li>
<li>
<p><code>zero_time</code></p>
<p>The time values for each event interval can be recalculated to start from zero at the event indicator. Time values for ensemble-averaged intervals will always be re-calculated from zero, since the original time information is lost when ensembling.<br><br>
For repeated occlusion testing, the original time information for each occlusion interval is critical to subsequently model the exponential recovery function, so we keep this as <code>FALSE</code>.</p>
</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## identify and extract intervals by event label</span></span>
<span><span class="co">## re-join the returned list of data frames with each occlusion interval labelled as "interval"</span></span>
<span><span class="va">df_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_intervals.html">extract_intervals</a></span><span class="op">(</span></span>
<span>    <span class="va">df</span>,</span>
<span>    nirs_channels <span class="op">=</span> <span class="va">hhb</span>,        <span class="co">## only required to specify nirs_channels when ensemble-averaging</span></span>
<span>    event_labels <span class="op">=</span> <span class="st">"Occlusion"</span>, <span class="co">## event label used in file, must match string exactly</span></span>
<span>    span <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>,             <span class="co">## occlusion interval c(start, end) with reference to the event time value</span></span>
<span>    group_events <span class="op">=</span> <span class="st">"distinct"</span>,  <span class="co">## return each occlusion event separately</span></span>
<span>    zero_time <span class="op">=</span> <span class="cn">FALSE</span>           <span class="co">## preserve original time values at each event</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">## join back into a single grouped data frame, mostly for easier plotting below</span></span>
<span>    <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span>names_to <span class="op">=</span> <span class="st">"interval"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">## convert the "interval" column to a categorical factor</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">interval</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">interval</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">## add `mnirs` metadata back to the combined data frame, for plotting</span></span>
<span>    <span class="fu"><a href="../reference/create_mnirs_data.html">create_mnirs_data</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>            <span class="st">"nirs_channels"</span>,</span>
<span>            <span class="st">"time_channel"</span>,</span>
<span>            <span class="st">"event_channel"</span>,</span>
<span>            <span class="st">"sample_rate"</span></span>
<span>        <span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## visualise facet plot with all occlusion intervals for error checking</span></span>
<span><span class="co">## the steepest facets will be the first occlusions from the two trials</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">df_list</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>        strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        strip.placement <span class="op">=</span> <span class="st">"outside"</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">interval</span>, scales <span class="op">=</span> <span class="st">"free_x"</span>, nrow <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="oxcap-analysis_files/figure-html/extract%20intervals-1.png" class="quarto-figure quarto-figure-center" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can plot the sequence of extracted occlusion intervals to visually inspect the data. As expected, the first interval during each repeated occlusion trial appears the steepest, with the slope rapidly becoming less steep during each subsequent occlusion as mV̇O<sub>2</sub> recovers.</p>
<p>From here, we want to calculate the slope values for each of these occlusion intervals.</p>
</section></section><section class="section level2"><h2 id="calculate-occlusion-slopes">Calculate occlusion slopes<a class="anchor" aria-label="anchor" href="#calculate-occlusion-slopes"></a>
</h2>
<section class="level3"><h4 id="peak_slope">
<code>peak_slope()</code><a class="anchor" aria-label="anchor" href="#peak_slope"></a>
</h4>
<ul>
<li>
<p><code>x</code>, <code>t</code></p>
<p>This function takes in a vector of numeric data (<code>x</code>) and optional time values (<code>t</code>), processes the response variable <code>x</code> to find the peak local linear regression slope over the predictor variable <code>t</code> (defaults to sample number if not provided), and returns a list of parameters from that linear regression model.</p>
</li>
<li>
<p><code>width</code>, <code>span</code></p>
<p>Linear regression is performed within a rolling local window specified by one of either <code>width</code> or <code>span</code>. <code>width</code> defines a number of samples, whereas <code>span</code> defines a range of time in units of <code>time_channel</code>.<br><br>
For this occlusion protocol, the peak 3-sec slope will be extracted from each 5-sec occlusion interval.</p>
</li>
<li>
<p><code>align</code></p>
<p>The local rolling linear regression window can be <code>"centre"</code>-aligned around the target sample (<code>idx</code>), or it can be <code>"left"</code>-aligned with <code>idx</code> at the start of the window (forward-looking), or <code>"right"</code>-aligned with <code>idx</code> at the end of the window (backward-looking).</p>
</li>
<li>
<p><code>direction</code></p>
<p>By default, the peak positive (upward) or negative (downward) slope will be returned depending on the overall trend direction of the response variable <code>x</code>. This can be overridden by specifying either <code>"positive"</code> or <code>"negative"</code>.<br><br>
For processing deoxyhaeme, we will specify that the peak slope during occlusion should be positive, because deoxygenation increases.</p>
</li>
<li>
<p><code>partial</code></p>
<p>By default, a local window will only return a linear regression model if all samples within the window are valid. If <code>partial</code> is set to <code>TRUE</code>, then local windows will return a slope model as long as there are two or more valid samples.<br><br>
A window with fewer samples will tend to return steeper slope values, which may or may not be relevant to our interpretations. e.g., as an edge-case (literally at the edges of the data) in a noisy data set there may be two samples with an extreme local slope between them. We usually would want to ignore this outlier slope value.</p>
</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## iteratively find peak local slopes within each occlusion interval</span></span>
<span><span class="co">## return summary values for each factor level of "interval" grouping column</span></span>
<span><span class="va">slopes_df</span> <span class="op">&lt;-</span> <span class="va">df_list</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html" class="external-link">reframe</a></span><span class="op">(</span></span>
<span>        .by <span class="op">=</span> <span class="va">interval</span>,</span>
<span>        <span class="op">{</span></span>
<span>            <span class="va">slope_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/peak_slope.html">peak_slope</a></span><span class="op">(</span></span>
<span>                x <span class="op">=</span> <span class="va">hhb</span>, <span class="co">## response variable: deoxyhaeme</span></span>
<span>                t <span class="op">=</span> <span class="va">time</span>, <span class="co">## predictor variable: time in seconds</span></span>
<span>                span <span class="op">=</span> <span class="fl">3</span>, <span class="co">## steepest 3 sec slope</span></span>
<span>                align <span class="op">=</span> <span class="st">"left"</span>, <span class="co">## forward-looking from index sample</span></span>
<span>                direction <span class="op">=</span> <span class="st">"positive"</span>, <span class="co">## upward slope for hhb</span></span>
<span>                partial <span class="op">=</span> <span class="cn">FALSE</span> <span class="co">## allow only complete 3-sec segments, no NAs</span></span>
<span>            <span class="op">)</span></span>
<span>            <span class="co">## return time value (start time of 3-sec period) and slope value (μM/sec)</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>                time <span class="op">=</span> <span class="va">slope_params</span><span class="op">$</span><span class="va">t</span>,</span>
<span>                slope <span class="op">=</span> <span class="va">slope_params</span><span class="op">$</span><span class="va">slope</span></span>
<span>            <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        <span class="co">## manual factor by occlusions in each trial</span></span>
<span>        trial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_occlusions</span><span class="op">)</span>, <span class="fl">1L</span>, <span class="fl">2L</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        <span class="co">## recalculate time as starting from zero for each trial</span></span>
<span>        .by <span class="op">=</span> <span class="va">trial</span>,</span>
<span>        time <span class="op">=</span> <span class="va">time</span> <span class="op">-</span> <span class="va">time</span><span class="op">[</span><span class="fl">1L</span><span class="op">]</span>,</span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">trial</span>, <span class="va">time</span>, <span class="va">slope</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## create plot template</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">slopes_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">slope</span>, colour <span class="op">=</span> <span class="va">trial</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span></span>
<span>        name <span class="op">=</span> <span class="st">"Time (mm:ss)"</span>,</span>
<span>        breaks <span class="op">=</span> <span class="fu"><a href="../reference/breaks_timespan.html">breaks_timespan</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        labels <span class="op">=</span> <span class="va">format_hmmss</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.03</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="../reference/scale_colour_mnirs.html">scale_colour_mnirs</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu">bold</span><span class="op">(</span><span class="va">HHb</span> <span class="op">~</span> <span class="va">Slope</span> <span class="op">~</span> <span class="st">'(μM'</span> <span class="op">%.%</span> <span class="va">sec</span><span class="op">^</span><span class="st">'-1'</span> <span class="op">*</span> <span class="st">')'</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## plot observed slope values for each trial</span></span>
<span><span class="va">p</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">3</span>, shape <span class="op">=</span> <span class="fl">21</span>, stroke <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="oxcap-analysis_files/figure-html/find%20peak%20slopes-1.png" class="quarto-figure quarto-figure-center" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Plotting the returned slope values gives us a very nice indication of the exponential recovery response for mV̇O<sub>2</sub> after each brief exercise task.</p>
</section></section><section class="section level2"><h2 id="model-mvo2-recovery">Model mV̇O<sub>2</sub> recovery<a class="anchor" aria-label="anchor" href="#model-mvo2-recovery"></a>
</h2>
<section class="level3"><h4 id="monoexponential">
<code>monoexponential()</code><a class="anchor" aria-label="anchor" href="#monoexponential"></a>
</h4>
<ul>
<li>
<p><code>t</code></p>
<p>This function is the equation for either a 3- or 4-parameter monoexponential function. It takes in a predictor variable for time (<code>t</code>) and generates the response variable (<code>y</code>) for an exponential curve with characteristics determined by four coefficients.</p>
</li>
<li>
<p><code>A</code>, <code>B</code></p>
<p>The starting (baseline) value and the ending (asymptote) value, respectively for the monoexponential curve. Will define either an exponential association curve in the positive direction when <code>B</code> &gt; <code>A</code>, or exponential decay in the negative direction when <code>A</code> &gt; <code>B</code>.</p>
</li>
<li>
<p><code>tau</code></p>
<p>The time constant (𝜏) of the exponential function determines the steepness of the initial slope of the curve. <em>Tau</em> is approximated by the time required to converge 63.2% of the amplitude between <code>A</code> and <code>B</code>.<br><br>
The rate constant (<em>k</em>) is the inverse of the time constant (<code>k = 1 / tau</code>) and is also commonly used in NIRS research, including for OxCap assessment. In this example we will report <em>k</em> in units of min<sup>-1</sup>.</p>
</li>
<li>
<p><code>TD</code></p>
<p>TD is the optional fourth parameter which defines a time lag before the start of monoexponential behaviour. This can capture behaviour which does not respond instantaneously to an intervention with a delay or a transient acceleration phase before exponential behaviour.<br><br>
Often during repeated occlusions after exercise, the first occlusions may not conform to monoexponential behaviour, if the oxygen saturation is too low and limiting to mV̇O<sub>2</sub>. In these cases, a time delay parameter may be required to accurately capture the true monoexponential response. This example protocol was designed to avoid this potential delay and so a time delay parameter was not required.</p>
</li>
</ul></section><section class="level3"><h4 id="ss_monoexp3-ss_monoexp4">
<code>SS_monoexp3()</code>, <code>SS_monoexp4()</code>
<a class="anchor" aria-label="anchor" href="#ss_monoexp3-ss_monoexp4"></a>
</h4>
<ul>
<li>These self-starting non-linear curve functions allow for optimising monoexponential fit coefficients on existing data, with either a 3- or 4-parameter model using <code><a href="https://rdrr.io/r/stats/nls.html" class="external-link">nls()</a></code> or another non-linear optimiser function. They return a model with three or four coefficients and associated fit parameters.</li>
</ul>
<p>Having split our data set of times and slopes by trial, we can use <code><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">tidyr::nest()</a></code> <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map()</a></code> functions to iteratively fit a 3-parameter monoexponential model for slope over time, for each trial, and return the primary outcome coefficient; the rate constant (<em>k</em>), calculated as the inverse of the time constant (<em>tau</em>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## use 3-param monoexponential model for each trial</span></span>
<span><span class="co">## return fitted curve and time constant tau coefficient</span></span>
<span><span class="va">pred_df</span> <span class="op">&lt;-</span> <span class="va">slopes_df</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">## nest the data to model each trial</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="va">trial</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        <span class="co">## apply self-starting monoexp model to each trial</span></span>
<span>        model <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">data</span>, \<span class="op">(</span><span class="va">.df</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/stats/nls.html" class="external-link">nls</a></span><span class="op">(</span><span class="va">slope</span> <span class="op">~</span> <span class="fu"><a href="../reference/SS_monoexp.html">SS_monoexp3</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">A</span>, <span class="va">B</span>, <span class="va">tau</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.df</span><span class="op">)</span></span>
<span>        <span class="op">}</span><span class="op">)</span>,</span>
<span>        <span class="co">## return tau coefficient for each trial model</span></span>
<span>        tau <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">model</span>, \<span class="op">(</span><span class="va">.m</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">.m</span><span class="op">)</span><span class="op">[[</span><span class="st">"tau"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        <span class="co">## return the predicted exponential curve values for plotting</span></span>
<span>        data <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">model</span>, \<span class="op">(</span><span class="va">.df</span>, <span class="va">.m</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">.df</span>, predicted_slope <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">.m</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">trial</span>, <span class="va">tau</span>, <span class="va">data</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">## unnest back into the top level data frame for extraction and plotting</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## extract tau and k coef labels per trial, for plotting</span></span>
<span><span class="va">coef_df</span> <span class="op">&lt;-</span> <span class="va">pred_df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>        .by <span class="op">=</span> <span class="va">trial</span>,</span>
<span>        label <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html" class="external-link">str_glue</a></span><span class="op">(</span></span>
<span>            <span class="st">"Trial {trial[1]}</span></span>
<span><span class="st">            tau = {mnirs:::signif_trailing(tau[1], 1)} sec</span></span>
<span><span class="st">            k = {mnirs:::signif_trailing(60 / tau[1], 1)} min⁻¹"</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## add predicted values to the plot of observed data</span></span>
<span><span class="va">p</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">pred_df</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">predicted_slope</span>, group <span class="op">=</span> <span class="va">trial</span><span class="op">)</span>,</span>
<span>        colour <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">coef_df</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">label</span>, colour <span class="op">=</span> <span class="va">trial</span>, group <span class="op">=</span> <span class="va">trial</span><span class="op">)</span>,</span>
<span>        x <span class="op">=</span> <span class="cn">Inf</span>, y <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>        size <span class="op">=</span> <span class="fl">5</span>, hjust <span class="op">=</span> <span class="fl">1.1</span>, vjust <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">3</span>, shape <span class="op">=</span> <span class="fl">21</span>, stroke <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="oxcap-analysis_files/figure-html/plot%20modelled%20data-1.png" class="quarto-figure quarto-figure-center" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section></section><section class="section level2"><h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This article demonstrates how muscle oxidative capacity analysis can be performed using <em>{mnirs}</em> and some relatively simple, reproducible data wrangling steps.</p>
<p>In future development, I would like to wrap some of these processing steps into dedicated functions with recommended default parameters, to make the analysis process more streamlined.</p>
<p>However, there are also a few limitations to this current process: modelling monoexponential behaviour with relatively few data samples (there are 17 occlusions per trial in this example) can result in unstable fit parameters or inability to converge non-linear fitting at all.</p>
<p>A more robust fitting process may be required for real-world data where mV̇O<sub>2</sub> recovery does not perfectly conform to monoexponential behaviour. Or, manual processing steps may be inevitably required during analysis to accommodate for these computational limitations.</p>
</section><section class="section level2"><h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body" data-entry-spacing="0" role="list">
<div id="ref-Beever2020" class="csl-entry" role="listitem">
<div class="csl-left-margin">[1] </div>
<div class="csl-right-inline">Beever AT, Tripp TR, Zhang J, et al. NIRS-derived skeletal muscle oxidative capacity is correlated with aerobic fitness and independent of sex. J Appl Physiol (1985) 2020;129:558–68. <a href="https://doi.org/10.1152/japplphysiol.00017.2020" class="external-link">https://doi.org/10.1152/japplphysiol.00017.2020</a>.</div>
</div>
<div id="ref-McCully2024" class="csl-entry" role="listitem">
<div class="csl-left-margin">[2] </div>
<div class="csl-right-inline">McCully KK, Stoddard SN, Reynolds MA, et al. Skeletal muscle oxidative metabolism during exercise measured with near infrared spectroscopy. NDT 2024;2:417–29. <a href="https://doi.org/10.3390/ndt2040025" class="external-link">https://doi.org/10.3390/ndt2040025</a>.</div>
</div>
<div id="ref-Adami2018" class="csl-entry" role="listitem">
<div class="csl-left-margin">[3] </div>
<div class="csl-right-inline">Adami A, Rossiter HB. Principles, insights, and potential pitfalls of the noninvasive determination of muscle oxidative capacity by near-infrared spectroscopy. J Appl Physiol (1985) 2018;124:245–8. <a href="https://doi.org/10.1152/japplphysiol.00445.2017" class="external-link">https://doi.org/10.1152/japplphysiol.00445.2017</a>.</div>
</div>
<div id="ref-Ryan2013" class="csl-entry" role="listitem">
<div class="csl-left-margin">[4] </div>
<div class="csl-right-inline">Ryan TE, Southern WM, Reynolds MA, et al. A cross-validation of near-infrared spectroscopy measurements of skeletal muscle oxidative capacity with phosphorus magnetic resonance spectroscopy. J Appl Physiol (1985) 2013;115:1757–66. <a href="https://doi.org/10.1152/japplphysiol.00835.2013" class="external-link">https://doi.org/10.1152/japplphysiol.00835.2013</a>.</div>
</div>
<div id="ref-Tripp2023" class="csl-entry" role="listitem">
<div class="csl-left-margin">[5] </div>
<div class="csl-right-inline">Tripp TR, McDougall RM, Frankish BP, et al. Contraction intensity affects NIRS-derived skeletal muscle oxidative capacity but not its relationships to mitochondrial protein content or aerobic fitness. Journal of Applied Physiology 2023. <a href="https://doi.org/10.1152/japplphysiol.00342.2023" class="external-link">https://doi.org/10.1152/japplphysiol.00342.2023</a>.</div>
</div>
<div id="ref-Costalat2025" class="csl-entry" role="listitem">
<div class="csl-left-margin">[6] </div>
<div class="csl-right-inline">Costalat G, Sautillet B, Millet GP, et al. Steepest near-infrared spectroscopy-derived deoxygenation slopes during arterial occlusions provide more reliable assessments of muscle mitochondrial capacity. Exp Physiol 2025. <a href="https://doi.org/10.1113/EP093040" class="external-link">https://doi.org/10.1113/EP093040</a>.</div>
</div>
<div id="ref-Rasica2024" class="csl-entry" role="listitem">
<div class="csl-left-margin">[7] </div>
<div class="csl-right-inline">Rasica L, Inglis EC, Mazzolari R, et al. Methodological considerations on near-infrared spectroscopy derived muscle oxidative capacity. European Journal of Applied Physiology 2024. <a href="https://doi.org/10.1007/s00421-024-05421-6" class="external-link">https://doi.org/10.1007/s00421-024-05421-6</a>.</div>
</div>
<div id="ref-Ryan2012" class="csl-entry" role="listitem">
<div class="csl-left-margin">[8] </div>
<div class="csl-right-inline">Ryan TE, Erickson ML, Brizendine JT, et al. Noninvasive evaluation of skeletal muscle mitochondrial capacity with near-infrared spectroscopy: Correcting for blood volume changes. J Appl Physiol (1985) 2012;113:175–83. <a href="https://doi.org/10.1152/japplphysiol.00319.2012" class="external-link">https://doi.org/10.1152/japplphysiol.00319.2012</a>.</div>
</div>
</div>
</section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jem Arnold.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
