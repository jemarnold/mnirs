% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/replace_mnirs.R
\name{replace_mnirs}
\alias{replace_mnirs}
\alias{replace_invalid}
\alias{replace_outliers}
\alias{replace_missing}
\title{Replace outliers, invalid values, and missing values}
\usage{
replace_mnirs(
  data,
  nirs_channels = NULL,
  time_channel = NULL,
  invalid_values = NULL,
  invalid_above = NULL,
  invalid_below = NULL,
  outlier_cutoff = NULL,
  width = NULL,
  span = NULL,
  method = c("linear", "median", "locf", "none"),
  verbose = TRUE
)

replace_invalid(
  x,
  t = seq_along(x),
  invalid_values = NULL,
  invalid_above = NULL,
  invalid_below = NULL,
  width = NULL,
  span = NULL,
  method = c("median", "none"),
  bypass_checks = FALSE,
  verbose = TRUE
)

replace_outliers(
  x,
  t = seq_along(x),
  outlier_cutoff = 3L,
  width = NULL,
  span = NULL,
  method = c("median", "none"),
  bypass_checks = FALSE,
  verbose = TRUE
)

replace_missing(
  x,
  t = seq_along(x),
  width = NULL,
  span = NULL,
  method = c("linear", "median", "locf"),
  bypass_checks = FALSE,
  verbose = TRUE,
  ...
)
}
\arguments{
\item{data}{A data frame of class \emph{"mnirs"} containing time series data
and metadata.}

\item{nirs_channels}{A character vector of mNIRS channel names to operate
on. Must match column names in \code{data} exactly. Retrieved from metadata
if not defined explicitly.}

\item{time_channel}{A character string indicating the time or sample channel
name. Must match column names in \code{data} exactly. Retrieved from metadata
if not defined explicitly.}

\item{invalid_values}{A numeric vector of invalid values to be replaced,
e.g. \code{invalid_values = c(0, 100, 102.3)}. The \emph{default} \code{NULL} will not
replace invalid values.}

\item{invalid_above, invalid_below}{Numeric values each specifying cutoff
values, above or below which (respectively) will be replaced, \emph{inclusive}
of the specified cutoff values.}

\item{outlier_cutoff}{An integer for the local outlier threshold, as
number of standard deviations above and below the local median. The
\emph{default} \code{outlier_cutoff = NULL} will not replace outliers.
\code{outlier_cutoff = 3} is the standard replacement threshold following
Pearson's rule.}

\item{width}{An integer defining the local window in number of samples
around \code{idx} in which to perform the operation., between
\verb{[idx - floor(width/2), idx + floor(width/2)]}.}

\item{span}{A numeric value defining the local window timespan around \code{idx}
in which to perform the operation. In units of \code{time_channel} or \code{t},
between \verb{[t - span/2, t + span/2]}.}

\item{method}{A character string indicating how to handle replacement
(see \emph{Details} for more on each method):
\describe{
\item{\code{"linear"}}{Replaces \code{NA}s via linear interpolation (the
\emph{default}) using \code{\link[stats:approxfun]{stats::approx()}}.}
\item{\code{"median"}}{Replaces \code{NA}s with the local median of valid values
within a centred window defined by either \code{width} or \code{span}.}
\item{\code{"locf"}}{(\emph{"Last observation carried forward"}). Replaces
\code{NA}s with the most recent valid non-\code{NA} value to the left for
trailing \code{NA}s or to the right for leading \code{NA}s, using
\code{\link[stats:approxfun]{stats::approx()}}.}
\item{\code{"none"}}{Returns \code{NA}s without replacement.}
}}

\item{verbose}{A logical to display (the \emph{default}) or silence (\code{FALSE})
warnings and information messages used for troubleshooting.}

\item{x}{A numeric vector of the response variable.}

\item{t}{An \emph{optional} numeric vector of the predictor variable; time
or sample number. \emph{Defaults} to indices of \code{t = seq_along(x)}.}

\item{bypass_checks}{A logical allowing wrapper functions to bypass redundant
checks and validations.}

\item{...}{Additional arguments.}
}
\value{
\code{replace_mnirs()} returns a \link[tibble:tibble-package]{tibble} of class
\emph{"mnirs"} with metadata available with \code{attributes()}.

Vectorised \verb{replace_*()} return a numeric vector the same length as \code{x}.
}
\description{
\code{replace_mnirs()} detects and removes local outliers and specified invalid
values in \code{nirs_channels} within an \emph{"mnirs"} data frame, and replaces
missing \code{NA} values via interpolation methods.

\code{replace_invalid()} detects specified invalid values or cutoff values in
vector data and replaces them with the local median value or \code{NA}.

\code{replace_outliers()} detects local outliers in vector data with a Hampel
filter and replaces with the local median value or \code{NA}.

\code{replace_missing()} detects missing values in vector data and replaces
via interpolation methods.
}
\details{
\code{replace_mnirs()} is a wrapper function expanding the vectorised \verb{replace_*}
functions to operate on a data frame.

\code{nirs_channels} and \code{time_channel} can be retrieved automatically from
\code{data} of class \emph{"mnirs"} which has been processed with \code{{mnirs}},
if not defined explicitly.

Channels (columns) in \code{data} not explicitly defined in \code{nirs_channels}
will be passed through untouched to the output data frame.

\code{replace_outliers} and \code{replace_missing} when \code{method = "median"} require
defining a local rolling window in which to perform outlier detection and
median interpolation. This window can be specified by either \code{width} as
the number of samples centred on \code{idx} between
\verb{[idx - floor(width/2), idx + floor(width/2)]}, or \code{span} as the timespan
in units of \code{time_channel} centred on \code{idx} between
\verb{[t - span/2, t + span/2]}. Specifying \code{width} is often faster than
\code{span}. A partial moving average will be calculated at the edges of the
data.

\code{replace_invalid()} can be used to remove known invalid values in
exported data.
\itemize{
\item Specific \code{invalid_values} can be replaced, such as \code{c(0, 100, 102.3)}.
Data ranges can be replaced with cutoff values specified by \code{invalid_above}
and \code{invalid_below}, where any values higher or lower than the specified
cutoff values (respectively) will be replaced, \emph{inclusive} of the cutoff
values themselves.
}

\code{replace_outliers()} will compute rolling local median values across \code{x},
defined by either \code{width} number of samples, or \code{span} timespan in units
of \code{t}. Specifying \code{width} is often faster than \code{span}.
\itemize{
\item Outliers are detected with robust median absolute deviation (MAD) method
adapted from \code{\link[pracma:hampel]{pracma::hampel()}}. Outliers equal to or less than the
smallest absolute time series difference in \code{x} will be excluded, to
avoid detecting negligible differences as outliers where local data have
minimal or zero variation.
\item Values of \code{x} outside local bounds defined by \code{outlier_cutoff} are
identified as local outliers and either removed if \code{method = "none"}, or
replaced with the local median value (\code{method = "median"}, the \emph{default}).
\item This function will NOT replace \code{NA} values already existing in the \code{x}.
They will be passed along in the returned vector. See \code{replace_missing()}.
\item A high \code{outlier_cutoff} threshold makes the Hampel filter more forgiving.
A low \code{outlier_cutoff} will declare more points to be outliers.
\code{outlier_cutoff = 3} corresponds to Pearson's 3 sigma edit rule.
\code{outlier_cutoff = 0} corresponds to Tukey's median filter.
}

\code{replace_missing()} will interpolate across missing values (\code{NA}s) as
specified by \code{method}.
\itemize{
\item Leading and trailing \code{NA}s are replaced by \emph{"nocb"} (\emph{"next observation}
\emph{carried backward"}) and \emph{"locf"}, respectively, for both \verb{method = }
\code{"linear"} and \code{"locf"}, by applying \code{rule = 2} (see \code{\link[stats:approxfun]{stats::approx()}}).
\item \code{method = "median"} will calculate the local median of valid (non-\code{NA})
values to either side of \code{NA}s within a window defined by \code{width} number
of samples, or a timespan defined by \code{span} in units of \code{t} (time). Such
that sequential \code{NA}s will all be replaced by the same median value.
\item If there are no valid values within \code{span} to one side of the \code{NA}
value(s), it will be replaced with the median of the other side (i.e. for
leading and trailing \code{NA}s). If there are no valid values within either
side of \code{span}, the first valid sample on either side will be used (i.e.
equivalent to \code{replace_missing(x, width = 1)}).
}
}
\examples{
\dontshow{if ((identical(Sys.getenv("NOT_CRAN"), "true") || identical(Sys.getenv("IN_PKGDOWN"), "true"))) withAutoprint(\{ # examplesIf}

## vectorised operation
x <- c(1, 999, 3, 4, 999, 6)
replace_invalid(x, invalid_values = 999, width = 2, method = "median")

(x_na <- replace_outliers(x, outlier_cutoff = 3, width = 2, method = "none"))

replace_missing(x_na, method = "linear")

## read example data
data <- read_mnirs(
    file_path = example_mnirs("moxy_ramp"),
    nirs_channels = c(smo2 = "SmO2 Live"),
    time_channel = c(time = "hh:mm:ss"),
    verbose = FALSE
)

## clean data
data_clean <- replace_mnirs(
    data,
    nirs_channels = NULL, ## nirs_channels will be retrieved from metadata
    time_channel = NULL,  ## retrieved from metadata
    invalid_values = 0,   ## known invalid values in the data
    invalid_above = 90,   ## remove data spikes
    outlier_cutoff = 3,   ## recommended default value
    width = 10,           ## window to detect local outliers
    method = "linear",    ## linear interpolation over `NA`s
    verbose = FALSE
)

library(ggplot2)
## plot original and and show where values have been replaced
plot(data, label_time = TRUE) +
    scale_colour_manual(
        name = NULL,
        breaks = c("smo2", "replaced"),
        values = palette_mnirs(2)
    ) +
    geom_point(
        data = data[data_clean$smo2 != data$smo2, ],
        aes(y = smo2, colour = "replaced"), na.rm = TRUE
    ) +
    geom_line(
        data = {
            data_clean[!is.na(data$smo2), "smo2"] <- NA
            data_clean
        },
        aes(y = smo2, colour = "replaced"), linewidth = 1, na.rm = TRUE
    )
\dontshow{\}) # examplesIf}
}
\seealso{
\code{\link[pracma:hampel]{pracma::hampel()}}, \code{\link[stats:approxfun]{stats::approx()}}
}
