% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/replace_mnirs.R
\name{replace_mnirs}
\alias{replace_mnirs}
\alias{replace_invalid}
\alias{replace_outliers}
\alias{replace_missing}
\title{Replace outliers, invalid values, and missing values}
\usage{
replace_mnirs(
  data,
  nirs_channels = NULL,
  time_channel = NULL,
  invalid_values = NULL,
  outlier_cutoff = NULL,
  width = NULL,
  span = NULL,
  method = c("linear", "median", "locf", "NA"),
  verbose = TRUE
)

replace_invalid(
  x,
  t = seq_along(x),
  invalid_values,
  width = NULL,
  span = NULL,
  method = c("median", "NA"),
  verbose = TRUE
)

replace_outliers(
  x,
  t = seq_along(x),
  outlier_cutoff = 3,
  width = NULL,
  span = NULL,
  method = c("median", "NA"),
  verbose = TRUE
)

replace_missing(
  x,
  t = seq_along(x),
  width = NULL,
  span = NULL,
  method = c("linear", "median", "locf"),
  ...
)
}
\arguments{
\item{data}{A data frame of class \emph{"mnirs"} containing at least one
column with numeric time or sample values, and one column with numeric
mNIRS values, along with metadata.}

\item{nirs_channels}{A character vector of mNIRS channel names. Must match
column names in \code{data} exactly. Will be taken from metadata if not
defined explicitly.}

\item{time_channel}{A character string indicating the time or sample channel
name. Must match column names in \code{data} exactly. Will be taken from
metadata if not defined explicitly.}

\item{invalid_values}{A numeric vector of invalid values to be replaced,
e.g. \code{invalid_values = c(0, 100, 102.3)}. The \emph{default} \code{NULL} will not
replace invalid values.}

\item{outlier_cutoff}{An integer for the local outlier threshold, as
number of standard deviations above and below the local median. The
\emph{default} \code{outlier_cutoff = NULL} will not replace outliers.
\code{outlier_cutoff = 3} is the standard replacement threshold following
Pearson's rule.}

\item{width}{An integer defining the window in number of samples around
\code{idx} in which to detect local outliers and perform median replacement,
between \verb{[idx - width, idx + width]}.}

\item{span}{A numeric value defining window timespan around \code{idx} in which
to detect local outliers and perform median replacement. In units of
\code{time_channel} or \code{t}, between \verb{[t - span, t + span]}.}

\item{method}{A character string indicating how to handle replacement
(see \emph{Details} for more on each method):
\describe{
\item{\code{"linear"}}{Replaces \code{NA}s via linear interpolation (the
\emph{default}) using \code{\link[stats:approxfun]{stats::approx()}}.}
\item{\code{"median"}}{Replaces \code{NA}s with the local median of valid values
within a centred window defined by either \code{width} or \code{span}.}
\item{\code{"locf"}}{(\emph{"Last observation carried forward"}). Replaces
\code{NA}s with the most recent valid non-\code{NA} value to the left for
trailing \code{NA}s or to the right for leading \code{NA}s, using
\code{\link[stats:approxfun]{stats::approx()}}.}
\item{\code{"NA"}}{Returns \code{NA}s without replacement.}
}}

\item{verbose}{A logical to return (the \emph{default}) or silence warnings and
messages which can be used for data error checking. Abort errors will
always be returned.}

\item{x}{A numeric vector.}

\item{t}{An \emph{optional} numeric vector of time or sample number.}

\item{...}{Additional arguments.}
}
\value{
\code{replace_mnirs()} returns a \link[tibble:tibble-package]{tibble} of class
\emph{"mnirs"} with metadata available with \code{attributes()}.

Vectorised \verb{replace_*()} return a numeric vector the same length as \code{x}.
}
\description{
\code{replace_mnirs()} detects and removes local outliers and specified invalid
values in \code{nirs_channels} within an \emph{"mnirs"} data frame, and replaces
missing \code{NA} values via interpolation methods.

\code{replace_invalid()} detects specified invalid values in vector data and
replaces them with the local median value or \code{NA}.

\code{replace_outliers()} detects local outliers in vector data with a Hampel
filter and replaces with the local median value or \code{NA}.

\code{replace_missing()} detects missing values in vector data and replaces
via interpolation methods.
}
\details{
\code{replace_mnirs()} is a wrapper function expanding the vectorised \verb{replace_*}
functions to operate on a data frame.

\code{nirs_channels} and \code{time_channel} can be retrieved automatically from
\code{data} of class \emph{"mnirs"} which has been processed with \code{{mnirs}},
if not defined explicitly.

Channels (columns) in \code{data} not explicitly defined in \code{nirs_channels}
will be passed through untouched to the output data frame.

\code{replace_invalid()} can be used to overwrite known invalid values in
exported data, such as \code{c(0, 100, 102.3)}.
\itemize{
\item \verb{<under development>}: \emph{allow for overwriting all values greater or less
than specified values.}
}

\code{replace_outliers()} will compute local rolling median values across \code{x},
defined by either \code{width} number of samples, or \code{span} timespan in units
of \code{t}.
\itemize{
\item Outliers are detected with robust median absolute deviation (MAD) method
adapted from \code{\link[pracma:hampel]{pracma::hampel()}}. Outliers equal to or less than the
smallest absolute time series difference in \code{x} will be excluded, to
avoid detecting negligible differences as outliers where local data have
minimal or zero variation.
\item Values of \code{x} outside local bounds defined by \code{outlier_cutoff} are
identified as local outliers and either removed if \code{method = "NA"}, or
replaced with the local median value (\code{method = "median"}, the \emph{default}).
\item This function will NOT replace \code{NA} values already existing in the \code{x}.
They will be passed along in the returned vector. See \code{replace_missing()}.
\item A high \code{outlier_cutoff} threshold makes the Hampel filter more forgiving.
A low \code{outlier_cutoff} will declare more points to be outliers.
\code{outlier_cutoff = 3} corresponds to Pearson's 3 sigma edit rule.
\code{outlier_cutoff = 0} corresponds to Tukey's median filter.
}

\code{replace_missing()} will interpolate across missing values (\code{NA}s) as
specified by \code{method}.
\itemize{
\item Leading and trailing \code{NA}s are replaced by \emph{"nocb"} (\emph{"next observation}
\emph{carried backward"}) and \emph{"locf"}, respectively, for both \verb{method = }
\code{"linear"} and \code{"locf"}, by applying \code{rule = 2} (see \code{\link[stats:approxfun]{stats::approx()}}).
\item \code{method = "median"} will calculate the local median of valid (non-\code{NA})
values to either side of \code{NA}s within a window defined by \code{width} number
of samples, or a timespan defined by \code{span} in units of \code{t} (time). Such
that sequential \code{NA}s will all be replaced by the same median value.
\item If there are no valid values within \code{span} to one side of the \code{NA}
value(s), it will be replaced with the median of the other side (i.e. for
leading and trailing \code{NA}s). If there are no valid values within either
side of \code{span}, the first valid sample on either side will be used (i.e.
equivalent to \code{replace_missing(x, width = 1)}).
}
}
\examples{
## vectorised operation
x <- c(1, 999, 3, 4, 999, 6)
replace_invalid(x, invalid_values = 999, width = 1, method = "median")

x_na <- replace_outliers(x, outlier_cutoff = 3, width = 1, method = "NA")
x_na

replace_missing(x_na, method = "linear")

## read example data
data <- read_mnirs(
    file_path = example_mnirs("moxy_ramp"),
    nirs_channels = c(smo2 = "SmO2 Live"),
    time_channel = c(time = "hh:mm:ss"),
    verbose = FALSE
)

## clean data
data_clean <- replace_mnirs(
    data,
    nirs_channels = NULL,       ## default to all nirs_channels in metadata
    time_channel = NULL,        ## default to time_channel in metadata
    invalid_values = c(0, 100), ## known invalid values in the data
    outlier_cutoff = 3,         ## recommended default value
    width = 7,                  ## local window to detect local outliers and replace missing values
    method = "linear",          ## linear interpolation over `NA`s
)

\dontrun{
## plot original and and show where values have been replaced
plot(data, label_time = TRUE) +
    scale_colour_manual(
        breaks = c("smo2", "replaced"),
        values = palette_mnirs(2)
    ) +
    geom_point(
        data = data[data_clean$smo2 != data$smo2, ],
        aes(y = smo2, colour = "replaced")
    ) +
    geom_line(
        data = {
            data_clean[!is.na(data$smo2), "smo2"] <- NA
            data_clean
        },
        aes(y = smo2, colour = "replaced"), linewidth = 1
    )
}

}
\seealso{
\code{\link[pracma:hampel]{pracma::hampel()}} \code{\link[stats:approxfun]{stats::approx()}}
}
